<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- This meta tag grants permission to load images from any secure source. -->
    <meta http-equiv="Content-Security-Policy" content="img-src https: data:;">

    <title>WorthIT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-enter { transition: opacity 300ms ease-out; }
        .modal-enter-from { opacity: 0; }
        .modal-enter-to { opacity: 1; }
        .modal-leave { transition: opacity 300ms ease-in; }
        .modal-leave-from { opacity: 1; }
        .modal-leave-to { opacity: 0; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #FFB3C7; /* Klarna Pink */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Custom Klarna Pink colors for Tailwind */
        .bg-klarna-pink { background-color: #FFB3C7; }
        .hover\:bg-klarna-pink-dark:hover { background-color: #F5A9BB; }
        .text-klarna-pink { color: #FFB3C7; }
        .focus\:ring-klarna-pink:focus { 
            --tw-ring-color: #FFB3C7;
        }
    </style>
</head>
<body class="bg-black text-white antialiased">

    <div class="min-h-screen flex flex-col items-center justify-start p-4 pt-12">
        <!-- Header -->
        <header class="text-center mb-8">
             <h1 class="text-6xl font-extrabold tracking-tighter">
                <span class="text-white">WorthIt</span><span class="text-klarna-pink">.</span>
            </h1>
        </header>

        <!-- Main Content -->
        <main class="w-full max-w-md">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold tracking-tight text-white sm:text-4xl">Know the true cost. <span class="text-klarna-pink">Instantly.</span></h2>
            </div>

            <!-- Calculator Card -->
            <div class="bg-white text-black rounded-3xl shadow-2xl p-6 sm:p-8">
                <div class="space-y-6">
                    <div>
                        <label for="productName" class="block text-sm font-medium text-gray-700">What are you buying?</label>
                        <input type="text" id="productName" placeholder="e.g., Sony WH-1000XM5 Headphones" class="mt-1 block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-xl shadow-sm focus:ring-klarna-pink focus:border-pink-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="productPrice" class="block text-sm font-medium text-gray-700">How much is it? (£)</label>
                        <input type="number" id="productPrice" placeholder="e.g., 349" class="mt-1 block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-xl shadow-sm focus:ring-klarna-pink focus:border-pink-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="productCategory" class="block text-sm font-medium text-gray-700">What is it?</label>
                        <select id="productCategory" class="mt-1 block w-full px-4 py-3 bg-gray-100 border-gray-300 rounded-xl shadow-sm focus:ring-klarna-pink focus:border-pink-500 sm:text-sm">
                            <option>Select a category...</option>
                            <option value="Electronics">Electronics (e.g., Laptop, Phone)</option>
                            <option value="Appliance">Appliance (e.g., Washing Machine)</option>
                            <option value="Clothing">Clothing (e.g., Coat, Jeans)</option>
                            <option value="Shoes">Shoes / Footwear</option>
                            <option value="Furniture">Furniture (e.g., Bed, Sofa)</option>
                            <option value="Tool">Tool / Equipment</option>
                            <option value="Vehicle">Vehicle (e.g., Bicycle, Car)</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <button id="calculateBtn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-lg text-lg font-bold text-black bg-klarna-pink hover:bg-klarna-pink-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-klarna-pink transition-transform transform hover:scale-105">
                        Show Me the Value
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal for Results -->
    <div id="resultsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden modal-enter-from" data-transition>
        <!-- Spinner (now a direct child of the overlay) -->
        <div id="spinner" class="hidden">
            <div class="spinner"></div>
        </div>

        <!-- Results Card (initially hidden) -->
        <div id="modalContent" class="bg-white rounded-3xl shadow-2xl w-full max-w-sm text-black text-center p-6 hidden">
            <!-- Results Content -->
            <div id="resultsContent">
                 <!-- Image Container -->
                <div id="imageContainer" class="w-full h-48 bg-gray-100 rounded-2xl flex items-center justify-center mb-6 overflow-hidden">
                    <img id="productImage" src="" alt="Product Image" class="hidden w-full h-full object-cover">
                    <div id="imagePlaceholder" class="hidden">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                </div>

                <h2 class="text-2xl font-bold text-black">Worth It?</h2>
                <p class="text-6xl font-extrabold my-2 tracking-tight text-black">
                    <span id="resultValue"></span><span id="resultUnit" class="text-4xl text-black font-bold"></span>
                </p>
                <p id="resultPeriod" class="text-2xl font-bold mb-4 text-black"></p>
                <p id="calculationBasis" class="text-xs text-gray-400 mb-6"></p>

                <!-- Interactive Controls -->
                <div class="border-t border-gray-200 mt-6 pt-4 space-y-3 text-left">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-medium text-gray-600">Lifespan</span>
                        <div class="flex items-center space-x-3">
                            <button id="lifespanMinus" class="bg-gray-200 rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold hover:bg-gray-300">-</button>
                            <span id="lifespanValue" class="text-sm font-bold w-16 text-center"></span>
                            <button id="lifespanPlus" class="bg-gray-200 rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold hover:bg-gray-300">+</button>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span id="usageLabel" class="text-sm font-medium text-gray-600">Usage</span>
                        <div class="flex items-center space-x-3">
                            <button id="usageMinus" class="bg-gray-200 rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold hover:bg-gray-300">-</button>
                            <span id="usageValue" class="text-sm font-bold w-20 text-center"></span>
                            <button id="usagePlus" class="bg-gray-200 rounded-full h-7 w-7 flex items-center justify-center text-lg font-bold hover:bg-gray-300">+</button>
                        </div>
                    </div>
                </div>

                <div id="dealsSection" class="text-left mt-6">
                     <h3 class="text-lg font-bold mb-3">Live Deals</h3>
                     <div id="dealsList" class="space-y-2">
                        <!-- Deals will be injected here -->
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const calculateBtn = document.getElementById('calculateBtn');
        const resultsModal = document.getElementById('resultsModal');
        const modalContent = document.getElementById('modalContent');
        const spinner = document.getElementById('spinner');
        const resultsContent = document.getElementById('resultsContent');

        const resultValue = document.getElementById('resultValue');
        const resultUnit = document.getElementById('resultUnit');
        const resultPeriod = document.getElementById('resultPeriod');
        const calculationBasis = document.getElementById('calculationBasis');
        const dealsList = document.getElementById('dealsList');
        const productImage = document.getElementById('productImage');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        
        // Interactive controls
        const lifespanMinus = document.getElementById('lifespanMinus');
        const lifespanPlus = document.getElementById('lifespanPlus');
        const lifespanValue = document.getElementById('lifespanValue');
        const usageMinus = document.getElementById('usageMinus');
        const usagePlus = document.getElementById('usagePlus');
        const usageValue = document.getElementById('usageValue');
        const usageLabel = document.getElementById('usageLabel');

        // Global state for recalculation
        let currentPrice = 0;
        let currentLifespan = 0;
        let currentUsage = 0;
        let currentCategoryData = {};

        const categoryData = {
            "Electronics": { lifespan: 4, usage: 15, unit: 'hour', plural: 'hours' },
            "Appliance":   { lifespan: 8, usage: 4, unit: 'use', plural: 'uses' },
            "Clothing":    { lifespan: 3, usage: 2, unit: 'wear', plural: 'wears' },
            "Shoes":       { lifespan: 2, usage: 3, unit: 'wear', plural: 'wears' },
            "Furniture":   { lifespan: 8, usage: 7, unit: 'day', plural: 'days' },
            "Tool":        { lifespan: 10, usage: 1, unit: 'use', plural: 'uses' },
            "Vehicle":     { lifespan: 10, usage: 5, unit: 'day', plural: 'days' },
            "Other":       { lifespan: 5, usage: 3, unit: 'use', plural: 'uses' }
        };

        function formatPrice(price) {
            if (price < 1) {
                return { value: Math.round(price * 100), unit: 'p' };
            }
            return { value: price.toFixed(2), unit: '£' };
        }
        
        async function showResults() {
            const price = parseFloat(document.getElementById('productPrice').value);
            const category = document.getElementById('productCategory').value;
            const productName = document.getElementById('productName').value;

            if (!price || category === "Select a category..." || !productName) {
                alert("Please fill in all the fields.");
                return;
            }

            resultsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            requestAnimationFrame(() => {
                resultsModal.classList.remove('modal-enter-from');
            });
            
            spinner.classList.remove('hidden');
            modalContent.classList.add('hidden');

            try {
                const response = await fetch(`/.netlify/functions/get-product-data?productName=${encodeURIComponent(productName)}`);
                const productData = await response.json();

                if (productData.error) {
                    throw new Error(productData.error);
                }
                
                setTimeout(() => {
                    displayResults(price, category, productData);
                    spinner.classList.add('hidden');
                    modalContent.classList.remove('hidden');
                }, 1500);

            } catch (error) {
                console.error("Error fetching product data:", error);
                setTimeout(() => {
                    alert(error.message || "Failed to fetch product data. Please try again.");
                    hideModal();
                }, 500);
            }
        }

        function recalculate() {
            const totalUses = currentLifespan * 52 * currentUsage;
            const costPerUse = totalUses > 0 ? currentPrice / totalUses : 0;
            
            const formatted = formatPrice(costPerUse);
            resultValue.textContent = formatted.value;
            resultUnit.textContent = formatted.unit;
            resultPeriod.textContent = `per ${currentCategoryData.unit}`;
            
            lifespanValue.textContent = `${currentLifespan} ${currentLifespan > 1 ? 'years' : 'year'}`;
            usageValue.textContent = `${currentUsage} ${currentUsage > 1 ? currentCategoryData.plural : currentCategoryData.unit}/wk`;
            usageLabel.textContent = `Usage (per week)`;
            
            const lifespanText = `${currentLifespan}-year lifespan`;
            const usageText = `${currentUsage} ${currentUsage > 1 ? currentCategoryData.plural : currentCategoryData.unit} per week`;
            calculationBasis.textContent = `Calculated on usage of a ${lifespanText} with ${usageText}.`;
        }
        
        function displayResults(price, category, productData) {
            currentPrice = price;
            currentCategoryData = categoryData[category];
            currentLifespan = currentCategoryData.lifespan;
            currentUsage = currentCategoryData.usage;

            recalculate(); // Perform initial calculation and display

            const { imageUrl, deals } = productData;
            const productNameForImage = document.getElementById('productName').value || "Product";
            productImage.alt = productNameForImage;

            if (imageUrl && !imageUrl.includes('placehold.co')) {
                productImage.src = imageUrl;
                productImage.classList.remove('hidden');
                imagePlaceholder.classList.add('hidden');
            } else {
                productImage.classList.add('hidden');
                imagePlaceholder.classList.remove('hidden');
            }

            dealsList.innerHTML = '';
            if (deals && deals.length > 0) {
                 deals.forEach(deal => {
                    const dealEl = document.createElement('a');
                    dealEl.href = deal.link;
                    dealEl.target = '_blank';
                    dealEl.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg hover:bg-gray-200 transition-colors';
                    dealEl.innerHTML = `
                        <span class="font-medium">${deal.source}</span>
                        <span class="font-bold text-black">${deal.price}</span>
                    `;
                    dealsList.appendChild(dealEl);
                });
            } else {
                dealsList.innerHTML = '<p class="text-sm text-gray-500">No live deals found for this product.</p>';
            }
        }

        function hideModal() {
            document.body.style.overflow = '';
            resultsModal.classList.add('modal-leave-to');
            setTimeout(() => {
                resultsModal.classList.add('hidden');
                resultsModal.classList.remove('modal-leave-to');
                resultsModal.classList.add('modal-enter-from');
            }, 300);
        }

        calculateBtn.addEventListener('click', showResults);
        resultsModal.addEventListener('click', (e) => {
            if (e.target === resultsModal) {
                hideModal();
            }
        });
        
        // Event Listeners for new interactive controls
        lifespanMinus.addEventListener('click', () => {
            if (currentLifespan > 1) {
                currentLifespan--;
                recalculate();
            }
        });
        lifespanPlus.addEventListener('click', () => {
            currentLifespan++;
            recalculate();
        });
        usageMinus.addEventListener('click', () => {
            if (currentUsage > 1) {
                currentUsage--;
                recalculate();
            }
        });
        usagePlus.addEventListener('click', () => {
            currentUsage++;
            recalculate();
        });

    </script>
</body>
</html>

